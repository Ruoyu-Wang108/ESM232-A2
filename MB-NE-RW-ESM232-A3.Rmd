---
title: "Assignment3"
author: "Ruoyu Wang"
date: "4/14/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE)

library(tidyverse)
library(ggplot2)
library(dplyr)
library(tidyr)
library(purrr)

source("R/almond_yield_anomaly.R")

clim <- read.table("clim.txt")

#generate sums of January precipitation
precip <- clim %>% 
  filter(month == 1)

jan_precip_sum <- precip %>% 
  group_by(year) %>% 
  summarize(
    jan_precip_sum = sum(precip)
  )

#generate February minimum temperatures
temp <- clim %>% 
  filter(month == 2)

feb_temp_min <- temp %>% 
  group_by(year) %>%
  summarize(
    feb_tmin = min(tmin_c)
  )



```

```{r sensitivity analysis}

var_jan_precip_2= rnorm(mean=0.0043, sd = 0.001, n=500) 


sens_analysis = var_jan_precip_2 %>% map(~almond_yield_anomaly( feb_temp_min[,2],jan_precip_sum[,2], var_feb_min_t_1=-0.015,var_feb_min_t_2 = -0.0046, var_jan_precip_1 = -0.07, var_jan_precip_2 = .x, intercept = 0.28))



#unlist sens_analysis and convert to vector
SAvec<-unlist(sens_analysis)

#create vector of unique years for which there is data
yset<- jan_precip_sum$year 


#put results into Yield Anomaly Sensitivity Analysis dataframe
YA_SA_df<- data.frame(yset, SAvec) %>% 
  rename(year = yset, 
         yield_anomaly = SAvec) 

#add column to dataframe with the values of P^2 term coefficients used 
YA_SA_df$P2coeff=rep(var_jan_precip_2, length.out=lengths(YA_SA_df[1]), each=length(yset))

#plot results in a boxplot
ggplot(YA_SA_df, aes(x=year, y=yield_anomaly, group=year))+geom_boxplot()+labs(title = "California Almond Yield Anomalies (1989-2010)", 
       subtitle = "Sensitivity Analysis on Parameter 0.0043P^2", 
       x = "Year", y = "Yield Anomaly (tons/acre)") 





```

